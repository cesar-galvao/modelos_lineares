{
  "hash": "8155e9baadb4e7b62a215f099674b38b",
  "result": {
    "markdown": "---\ntitle: \"Questão 2\"\n---\n\n\nNesta seção, exploraremos dados referentes a 27 estabelecimentos industriais. Tentaremos explicar o número de supervisores em função do número de trabalhadores desses estabelecimentos.\n\nAs primeiras seis linhas desse conjunto de dados são expostos na tabela a seguir.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(tidyverse, tidymodels, cowplot)\n\nsupervisores <- read.table(\"supervisores.txt\", header = TRUE)\n\nhead(supervisores, 6) %>%\n  select(nsupervisores, ntrabalhadores) %>%\n  knitr::kable(\n    align = c(\"c\"),\n    booktabs = TRUE,\n    longtable = TRUE,\n    linesep = \"\",\n    escape = FALSE,\n    digits = 2\n    ) %>%\n  kableExtra::kable_styling(\n      position = \"center\",\n      latex_options = c(\"striped\", \"repeat_header\"),\n      stripe_color = \"gray!15\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:center;\"> nsupervisores </th>\n   <th style=\"text-align:center;\"> ntrabalhadores </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:center;\"> 30 </td>\n   <td style=\"text-align:center;\"> 294 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 32 </td>\n   <td style=\"text-align:center;\"> 247 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 37 </td>\n   <td style=\"text-align:center;\"> 267 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 44 </td>\n   <td style=\"text-align:center;\"> 358 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 47 </td>\n   <td style=\"text-align:center;\"> 423 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 49 </td>\n   <td style=\"text-align:center;\"> 311 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n## Análise exploratória\n\nIniciamos a análise exploratória com a inspeção visual do gráfico de dispersão entre a variável resposta, `nsupervisores`, e a variável explicativa, `ntrabalhadores`.\n\nÉ notável uma dispersão em formato de cone, o que sugere heteroscedasticidade da variável resposta.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(supervisores, aes(nsupervisores, ntrabalhadores))+\n  geom_point()+\n  labs(x = \"Trabalhadores\", y = \"Supervisores\") +\n  theme_bw()\n```\n\n::: {.cell-output-display}\n![](questao2_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\nAlém disso, é possível observar que as distribuições parecem razoavelmente simétricas, porém com leve assimetria positiva. O número de trabalhadores (20500) também é muito superior ao de supervisores (2550), havendo em média 8 trabalhadores por supervisor. Essa razão tem limite entre 6.2 e 12.2.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsupervisores %>%\n  select(\"Supervisores\" = nsupervisores, \"Trabalhadores\" = \"ntrabalhadores\") %>%\n  pivot_longer(cols = everything()) %>%\n  ggplot(aes(name, value))+\n  geom_boxplot()+\n  stat_summary(fun=mean, geom=\"point\", shape=5, size=2, color=\"black\", fill=\"gray\")+\n  theme_minimal()+\n  theme(axis.title = element_blank())\n```\n\n::: {.cell-output-display}\n![](questao2_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n\n## Ajuste de Modelo\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit <- lm(nsupervisores ~ ntrabalhadores, data = supervisores)\n```\n:::\n\n\n\nAjustamos um modelo de regressão linear simples usando a função `lm()`, cujos estimadores e suas características são espostos a seguir. O coeficiente de determinação do modelo é $R^2=$ 0.78.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntidy(fit) %>%\n  knitr::kable(\n    align = c(\"c\"),\n    booktabs = TRUE,\n    longtable = TRUE,\n    linesep = \"\",\n    escape = FALSE,\n    digits = 4,\n    col.names = c(\"\", \"Estimador\", \"Erro P.\", \"t\", \"p-valor\")\n    ) %>%\n  kableExtra::kable_styling(\n      position = \"center\",\n      latex_options = c(\"striped\", \"repeat_header\"),\n      stripe_color = \"gray!15\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:center;\">  </th>\n   <th style=\"text-align:center;\"> Estimador </th>\n   <th style=\"text-align:center;\"> Erro P. </th>\n   <th style=\"text-align:center;\"> t </th>\n   <th style=\"text-align:center;\"> p-valor </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:center;\"> (Intercept) </td>\n   <td style=\"text-align:center;\"> 14.4481 </td>\n   <td style=\"text-align:center;\"> 9.5620 </td>\n   <td style=\"text-align:center;\"> 1.5110 </td>\n   <td style=\"text-align:center;\"> 0.1433 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> ntrabalhadores </td>\n   <td style=\"text-align:center;\"> 0.1054 </td>\n   <td style=\"text-align:center;\"> 0.0113 </td>\n   <td style=\"text-align:center;\"> 9.3029 </td>\n   <td style=\"text-align:center;\"> 0.0000 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nnormalidade <- shapiro.test(fit$residuals)\n```\n:::\n\n\n\nO estimador do modelo tem as suas características dispostas na tabela a seguir. O coeficiente de determinação do modelo é de $R^2=$ 0.78, ou seja, 78% da variação da variável resposta pode ser explicada pela variável explicativa. \n\n\n::: {.cell}\n\n```{.r .cell-code}\ntidy(fit) %>%\n  knitr::kable(\n    align = c(\"c\"),\n    booktabs = TRUE,\n    longtable = TRUE,\n    linesep = \"\",\n    escape = FALSE,\n    digits = 4,\n    col.names = c(\"\", \"Estimador\", \"Erro P.\", \"t\", \"p-valor\")\n    ) %>%\n  kableExtra::kable_styling(\n      position = \"center\",\n      latex_options = c(\"striped\", \"repeat_header\"),\n      stripe_color = \"gray!15\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:center;\">  </th>\n   <th style=\"text-align:center;\"> Estimador </th>\n   <th style=\"text-align:center;\"> Erro P. </th>\n   <th style=\"text-align:center;\"> t </th>\n   <th style=\"text-align:center;\"> p-valor </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:center;\"> (Intercept) </td>\n   <td style=\"text-align:center;\"> 14.4481 </td>\n   <td style=\"text-align:center;\"> 9.5620 </td>\n   <td style=\"text-align:center;\"> 1.5110 </td>\n   <td style=\"text-align:center;\"> 0.1433 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> ntrabalhadores </td>\n   <td style=\"text-align:center;\"> 0.1054 </td>\n   <td style=\"text-align:center;\"> 0.0113 </td>\n   <td style=\"text-align:center;\"> 9.3029 </td>\n   <td style=\"text-align:center;\"> 0.0000 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nNo entanto, este coeficiente seria aplicável a um modelo com resíduos homocedásticos e com distribuição normal. Visualmente, já se trata de um modelo com resíduos heteroscedásticos porém, mediante aplicação de teste Shapiro-Wilk, obtém-se p-valor de 0.2, não sugerindo rejeição da normalidade.\n\n### Análise de resíduos Studentizados\n\nSe montarmos um gráfico de resposta versus resíduos Studentizados vemos novamente indícios para resíduos heteroscedásticos.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntibble(\n  ajustados = fitted(fit),\n  res_stu = stats::rstudent(fit)\n) %>%\n  ggplot(aes(ajustados, res_stu))+\n  geom_point() +\n  theme_bw()+\n  labs(x = \"Resposta ajustada\", y = \"Resíduos Studentizados\")\n```\n\n::: {.cell-output-display}\n![](questao2_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n### Avaliação de normalidade da resposta\n\nUma análise visual do gráfico dos resíduos Studentizados versus quantis da normal demonstram um padrão periódico com diversos pontos fora da banda de confiança. Contrariamente ao teste Shapiro-Wilk, esta avaliação sugere fuga da suposição de normalidade.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsource(\"envelope_function.R\")\n\nenvelope_LR(fit, OLS = T, main.title = \"Gráfico dos resíduos com envelope\")\n```\n\n::: {.cell-output-display}\n![](questao2_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n### Modelos sob Mínimos Quadrados Ponderados\n\nNesta seção supomos que $Var(Y) = \\sigma^2 V$, com $V = diag\\{x_1^p, x_2^p, \\dots, x_n^p\\}$, com $p = 1, 2, 3$. Ou seja, serão ajustados três modelos, transformações do modelo original, decompondo via Cholesky a matriz $V = PP^\\top$. O novo modelo é dado por\n\n$$\nP^{-1}Y = P^{-1}X\\beta + P^{-1}\\varepsilon \\quad \\Rightarrow \\quad Z = Q\\beta + \\eta\n$$\n\nDe fato, \n\n$$\nX = \\begin{bmatrix}\n1 & x_1\\\\\n1 & x_2 \\\\\n\\vdots & \\vdots \\\\\n1 & x_n\n\\end{bmatrix} \\quad \\Rightarrow \\quad Q = \\begin{bmatrix}\n\\frac{1}{\\sqrt{x_1^p}} & \\frac{x_1}{\\sqrt{x_1^p}}\\\\\n\\frac{1}{\\sqrt{x_2^p}} & \\frac{x_2}{\\sqrt{x_2^p}} \\\\\n\\vdots & \\vdots \\\\\n\\frac{1}{\\sqrt{x_3^p}} & \\frac{x_n}{\\sqrt{x_3^p}}\n\\end{bmatrix}\n$$\n\nque não possui um termo constante, portanto não possui intercepto. Os novos modelos são ajustados utilizando a mesma função `lm()`, porém ajustando o argumento `weights` = $1/(ntrabalhadores)^p$. A tabela com os estimadores e suas características para os modelos sem intercepto são expostas a seguir.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_w1 <- lm(nsupervisores ~ ntrabalhadores, weights = 1/(ntrabalhadores)^1, data = supervisores)\nfit_w2 <- lm(nsupervisores ~ ntrabalhadores, weights = 1/(ntrabalhadores)^2, data = supervisores)\nfit_w3 <- lm(nsupervisores ~ ntrabalhadores, weights = 1/(ntrabalhadores)^3, data = supervisores)\n\n\nbind_rows(tidy(fit_w1), tidy(fit_w2), tidy(fit_w3)) %>%\n  mutate(p = rep(1:3, each = 2), r2 = c(\n    summary(fit_w1)$r.squared,NA,\n    summary(fit_w2)$r.squared,NA,\n    summary(fit_w3)$r.squared,NA\n  )) %>%\n  select(p, everything()) %>%\n  knitr::kable(\n    align = c(\"c\"),\n    booktabs = TRUE,\n    longtable = TRUE,\n    linesep = \"\",\n    escape = FALSE,\n    digits = 4,\n    col.names = c(\"p\", \"Explicativa\", \"Estimador\", \"Erro P.\", \"t\", \"p-valor\", \"R2\")\n    ) %>%\n  kableExtra::kable_styling(\n      position = \"center\",\n      latex_options = c(\"striped\", \"repeat_header\"),\n      stripe_color = \"gray!15\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:center;\"> p </th>\n   <th style=\"text-align:center;\"> Explicativa </th>\n   <th style=\"text-align:center;\"> Estimador </th>\n   <th style=\"text-align:center;\"> Erro P. </th>\n   <th style=\"text-align:center;\"> t </th>\n   <th style=\"text-align:center;\"> p-valor </th>\n   <th style=\"text-align:center;\"> R2 </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:center;\"> 1 </td>\n   <td style=\"text-align:center;\"> (Intercept) </td>\n   <td style=\"text-align:center;\"> 7.7739 </td>\n   <td style=\"text-align:center;\"> 6.4302 </td>\n   <td style=\"text-align:center;\"> 1.2090 </td>\n   <td style=\"text-align:center;\"> 0.2380 </td>\n   <td style=\"text-align:center;\"> 0.8475 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 1 </td>\n   <td style=\"text-align:center;\"> ntrabalhadores </td>\n   <td style=\"text-align:center;\"> 0.1142 </td>\n   <td style=\"text-align:center;\"> 0.0097 </td>\n   <td style=\"text-align:center;\"> 11.7865 </td>\n   <td style=\"text-align:center;\"> 0.0000 </td>\n   <td style=\"text-align:center;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2 </td>\n   <td style=\"text-align:center;\"> (Intercept) </td>\n   <td style=\"text-align:center;\"> 3.8033 </td>\n   <td style=\"text-align:center;\"> 4.5697 </td>\n   <td style=\"text-align:center;\"> 0.8323 </td>\n   <td style=\"text-align:center;\"> 0.4131 </td>\n   <td style=\"text-align:center;\"> 0.8785 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 2 </td>\n   <td style=\"text-align:center;\"> ntrabalhadores </td>\n   <td style=\"text-align:center;\"> 0.1210 </td>\n   <td style=\"text-align:center;\"> 0.0090 </td>\n   <td style=\"text-align:center;\"> 13.4454 </td>\n   <td style=\"text-align:center;\"> 0.0000 </td>\n   <td style=\"text-align:center;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 3 </td>\n   <td style=\"text-align:center;\"> (Intercept) </td>\n   <td style=\"text-align:center;\"> 1.5628 </td>\n   <td style=\"text-align:center;\"> 3.7468 </td>\n   <td style=\"text-align:center;\"> 0.4171 </td>\n   <td style=\"text-align:center;\"> 0.6802 </td>\n   <td style=\"text-align:center;\"> 0.8792 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> 3 </td>\n   <td style=\"text-align:center;\"> ntrabalhadores </td>\n   <td style=\"text-align:center;\"> 0.1260 </td>\n   <td style=\"text-align:center;\"> 0.0093 </td>\n   <td style=\"text-align:center;\"> 13.4912 </td>\n   <td style=\"text-align:center;\"> 0.0000 </td>\n   <td style=\"text-align:center;\"> NA </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nDe fato, observa-se que o modelo transformado explica em torno de 7% a mais de variância do que o modelo não transformado, para qualquer valor de $p$ dentre os disponíveis.\n\nOs gráficos de resposta ajustada versus resíduos Studentizados e gráficos normais de probabilidade dos resíduos Studentizados com envelope simulado são expostos a seguir. De fato, utilizando $p = 3$ parece resultar em melhor comportamento dos resíduos, mas não é possível concluir nada sobre $p=2$.\n\n\n::: {.cell}\n\n```{.r .cell-code}\najuste1 <- tibble(\n  ajustados = fitted(fit_w1),\n  res_stu = stats::rstudent(fit_w1)\n) %>%\n  ggplot(aes(ajustados, res_stu))+\n  geom_point() +\n  theme_bw()+\n  labs(x = \"Resposta ajustada - p = 1\", y = \"Resíduos Studentizados\")\n\najuste2 <- tibble(\n  ajustados = fitted(fit_w2),\n  res_stu = stats::rstudent(fit_w2)\n) %>%\n  ggplot(aes(ajustados, res_stu))+\n  geom_point() +\n  theme_bw()+\n  labs(x = \"Resposta ajustada - p = 2\", y = \"Resíduos Studentizados\")\n\najuste3 <- tibble(\n  ajustados = fitted(fit_w3),\n  res_stu = stats::rstudent(fit_w3)\n) %>%\n  ggplot(aes(ajustados, res_stu))+\n  geom_point() +\n  theme_bw()+\n  labs(x = \"Resposta ajustada - p = 3\", y = \"Resíduos Studentizados\")\n\nplot_grid(ajuste1, ajuste2,ajuste3)\n```\n\n::: {.cell-output-display}\n![](questao2_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\nQuanto à avaliação da normalidade, utilizando os gráficos de envelope simulado a seguir, $p=3$ parece resultar na melhor opção.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow = c(2,2))\nenvelope_LR(fit_w1, OLS = F, main.title = \"Resíduos com envelope - p = 1\")\nenvelope_LR(fit_w2, OLS = F, main.title = \"Resíduos com envelope - p = 2\")\nenvelope_LR(fit_w3, OLS = F, main.title = \"Resíduos com envelope - p = 3\")\n```\n\n::: {.cell-output-display}\n![](questao2_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\nConsiderando as possiblidades apontadas, opta-se pelo modelo em que $p=3$.\n\n\n### Interpretação dos coeficientes estimados\n\nTendo-se optado por $p=3$, obtemos $\\beta_1 =$ 0.13. Isto significa que o acréscimo de cada trabalhador implicaria no acrescimo de 0.13 supervisor ou, para uma compreensão mais clara, haveria o acréscimo de um supervisor a cada 7.93 trabalhadores.\n\n\n### Intervalo confiança\n\nConstruimos um intervalo de confiança para $\\hat{\\beta_G}$ sob a condição.\n\n$$\n\\hat{\\beta_G} \\sim N(\\beta, \\sigma^2(X^{\\top}V^{-1}X)^{-1})\n$$\nE obtemos o seguinte intervalo de confiança:\n\n$$\n\\hat{\\beta_G} \\, \\pm \\, t_{n-2} \\, \\sqrt{\\hat\\sigma^2 (X^{\\top}V^{-1}X)^{-1})}\n$$\n\n\n\n\n\nCom limites $LI =$ 0.11 e $LS =$ 0.14.\n\n\n### Análise de variância\n\nFinalmente, montamos uma tabela de análise de variância:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntabela_anova <- tibble(\n  fonte = c(\"Regressão\", \"Resíduo\", \"Total\"),\n  gl = c(1, 25, 26),\n  SQ = c(SQReg_nc, SQRes, SQT_nc)\n) %>%\n  mutate(QM = SQ/gl)\n\nf0 <- c(tabela_anova$QM[1]/tabela_anova$QM[2], NA,NA)\npval <- c(1-pf(f0, 1, 25))\n\nbind_cols(tabela_anova, f0, pval) %>%\n  knitr::kable(\n    align = c(\"c\"),\n    booktabs = TRUE,\n    longtable = TRUE,\n    linesep = \"\",\n    escape = FALSE,\n    digits = 4,\n    col.names = c(\"Fonte\", \"g.l.\", \"SQ\", \"QM\", \"F\", \"p-valor\")\n    ) %>%\n  kableExtra::kable_styling(\n      position = \"center\",\n      latex_options = c(\"striped\", \"repeat_header\"),\n      stripe_color = \"gray!15\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nNew names:\n• `` -> `...5`\n• `` -> `...6`\n```\n:::\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:center;\"> Fonte </th>\n   <th style=\"text-align:center;\"> g.l. </th>\n   <th style=\"text-align:center;\"> SQ </th>\n   <th style=\"text-align:center;\"> QM </th>\n   <th style=\"text-align:center;\"> F </th>\n   <th style=\"text-align:center;\"> p-valor </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:center;\"> Regressão </td>\n   <td style=\"text-align:center;\"> 1 </td>\n   <td style=\"text-align:center;\"> 8e-04 </td>\n   <td style=\"text-align:center;\"> 8e-04 </td>\n   <td style=\"text-align:center;\"> 1041.385 </td>\n   <td style=\"text-align:center;\"> 0 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> Resíduo </td>\n   <td style=\"text-align:center;\"> 25 </td>\n   <td style=\"text-align:center;\"> 0e+00 </td>\n   <td style=\"text-align:center;\"> 0e+00 </td>\n   <td style=\"text-align:center;\"> NA </td>\n   <td style=\"text-align:center;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:center;\"> Total </td>\n   <td style=\"text-align:center;\"> 26 </td>\n   <td style=\"text-align:center;\"> 8e-04 </td>\n   <td style=\"text-align:center;\"> 0e+00 </td>\n   <td style=\"text-align:center;\"> NA </td>\n   <td style=\"text-align:center;\"> NA </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\nConcluimos pela análise de tabela de variância que nosso modelo transformado é adequado para explicar os dados.\n",
    "supporting": [
      "questao2_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"site_libs/kePrint-0.0.1/kePrint.js\"></script>\r\n<link href=\"site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}